<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MoonSight v3 â€“ Observatory-Grade Crescent Simulator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Cinzel:wght@400;600;900&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap');
:root{
  --gold:#c9a84c;--gold-dim:#8a6d2a;--data-green:#4ecdc4;--data-blue:#74b9ff;
  --text-muted:#6a7a8a;--panel-bg:rgba(4,10,22,0.93);--border:rgba(201,168,76,0.22);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#020408;color:#e8e4da;font-family:'Space Mono',monospace}
canvas{position:fixed;top:0;left:0;display:block}
#ui{position:fixed;inset:0;pointer-events:none;z-index:10}
#ui *{pointer-events:auto}
#hdr{position:absolute;top:0;left:0;right:0;display:flex;align-items:center;justify-content:space-between;padding:14px 26px;background:linear-gradient(to bottom,rgba(2,4,8,.97) 60%,transparent)}
.logo-main{font-family:'Cinzel',serif;font-size:20px;font-weight:900;color:var(--gold);letter-spacing:3px;text-shadow:0 0 18px rgba(201,168,76,.45)}
.logo-sub{font-family:'Crimson Pro',serif;font-size:11px;font-style:italic;color:var(--text-muted);letter-spacing:2px;margin-top:2px}
.hdr-coords{text-align:right;font-size:9px;line-height:1.9;color:var(--text-muted)}
.hdr-coords span{color:var(--data-blue);font-weight:700}
.panel{background:var(--panel-bg);border:1px solid var(--border);border-radius:8px;padding:13px;backdrop-filter:blur(14px)}
.plabel{font-size:8px;letter-spacing:3px;color:var(--gold-dim);text-transform:uppercase;margin-bottom:10px;font-family:'Cinzel',serif}
#lpanel{position:absolute;left:0;top:64px;bottom:0;width:292px;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(to right,rgba(2,4,8,.97) 82%,transparent)}
#rpanel{position:absolute;right:0;top:64px;width:276px;padding:12px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(to left,rgba(2,4,8,.97) 82%,transparent)}
#bpanel{position:absolute;bottom:0;left:0;right:0;padding:12px 24px;display:flex;align-items:center;gap:14px;background:linear-gradient(to top,rgba(2,4,8,.97) 70%,transparent)}
.ifield{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(201,168,76,.15);border-radius:4px;color:var(--data-blue);font-family:'Space Mono',monospace;font-size:11px;padding:7px 10px;outline:none;transition:border-color .2s}
.ifield:focus{border-color:rgba(201,168,76,.5)}
.ifield::placeholder{color:var(--text-muted)}
.ilbl{font-size:8px;color:var(--text-muted);letter-spacing:1px;margin-bottom:3px;text-transform:uppercase}
.irow{display:flex;gap:7px;margin-bottom:7px}
.btn{background:rgba(201,168,76,.07);border:1px solid var(--border);color:var(--gold);font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1.5px;padding:7px 12px;border-radius:4px;cursor:pointer;transition:all .18s;text-transform:uppercase;white-space:nowrap}
.btn:hover{background:rgba(201,168,76,.18);border-color:var(--gold);box-shadow:0 0 10px rgba(201,168,76,.2)}
.btn.active{background:rgba(201,168,76,.24);border-color:var(--gold);box-shadow:0 0 12px rgba(201,168,76,.3)}
.btn-full{width:100%;padding:10px;text-align:center}
.btn-eid{width:100%;padding:11px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;background:linear-gradient(135deg,rgba(201,168,76,.15),rgba(78,205,196,.08))}
.presets{display:flex;flex-wrap:wrap;gap:5px}
.pbtn{font-size:8px;padding:4px 9px;color:var(--text-muted);border-color:rgba(255,255,255,.09)}
.pbtn:hover{color:var(--data-blue);border-color:var(--data-blue)}
.dgrid{display:grid;gap:6px}
.ditem{background:var(--panel-bg);border:1px solid var(--border);border-radius:5px;padding:8px 12px;display:flex;justify-content:space-between;align-items:center}
.dkey{font-size:8px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase}
.dval{font-size:12px;font-weight:700;color:var(--data-blue)}
.dval.gold{color:var(--gold)}.dval.green{color:var(--data-green)}.dval.red{color:#ff6b6b}.dval.orange{color:#ffa07a}.dval.yellow{color:#ffd700}
#vbadge{text-align:center;padding:13px}
.vb-lbl{font-size:8px;letter-spacing:3px;color:var(--text-muted);text-transform:uppercase;margin-bottom:5px;font-family:'Cinzel',serif}
.vb-txt{font-family:'Cinzel',serif;font-size:13px;font-weight:600;letter-spacing:1px}
.vb-prob{font-size:10px;color:var(--text-muted);margin-top:3px}
.tdisp{font-family:'Cinzel',serif;font-size:17px;color:var(--gold);letter-spacing:2.5px;min-width:165px;text-shadow:0 0 12px rgba(201,168,76,.28)}
.tsub{font-size:8px;color:var(--text-muted);letter-spacing:1.5px;margin-top:2px}
.cbtns{display:flex;gap:5px;align-items:center}
.cbtn{width:34px;height:34px;background:rgba(201,168,76,.07);border:1px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--gold);font-size:13px;transition:all .18s;flex-shrink:0}
.cbtn:hover{background:rgba(201,168,76,.2);border-color:var(--gold)}
.cbtn.active{background:rgba(201,168,76,.25);border-color:var(--gold);box-shadow:0 0 10px rgba(201,168,76,.28)}
.cbtn-lg{width:42px;height:42px;font-size:15px}
#tslider{flex:1;-webkit-appearance:none;height:2px;background:rgba(201,168,76,.2);border-radius:2px;outline:none;cursor:pointer}
#tslider::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;background:var(--gold);border-radius:50%;cursor:pointer;box-shadow:0 0 8px rgba(201,168,76,.6)}
.trow{display:flex;align-items:center;justify-content:space-between;margin-top:7px}
.tlbl{font-size:8px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase}
.tog{width:30px;height:15px;background:rgba(255,255,255,.1);border-radius:8px;cursor:pointer;position:relative;transition:background .2s;border:1px solid rgba(255,255,255,.1);flex-shrink:0}
.tog.on{background:rgba(201,168,76,.28);border-color:var(--gold-dim)}
.tog::after{content:'';position:absolute;top:2px;left:2px;width:9px;height:9px;background:var(--text-muted);border-radius:50%;transition:all .2s}
.tog.on::after{left:17px;background:var(--gold)}
.atm-row{display:flex;gap:5px}
.atm-btn{flex:1;font-size:8px;padding:5px;text-align:center}
.atm-btn.active{background:rgba(201,168,76,.18);border-color:var(--gold);color:var(--gold)}
.phase-wrap{display:flex;align-items:center;gap:8px;margin-top:9px}
.pbar-bg{flex:1;height:2px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden}
.pbar{height:100%;background:linear-gradient(to right,var(--gold-dim),var(--gold));border-radius:2px;transition:width .5s ease}
.nmbox{background:rgba(201,168,76,.04);border:1px solid rgba(201,168,76,.1);border-radius:5px;padding:9px 11px;margin-top:7px}
.nmrow{display:flex;justify-content:space-between;font-size:9px;padding:2px 0}
.nmk{color:var(--text-muted)}.nmv{color:var(--gold);font-weight:700}
#modal{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(2,4,8,.9);backdrop-filter:blur(12px)}
#modal.show{display:flex}
.mpanel{background:var(--panel-bg);border:1px solid var(--border);border-radius:12px;padding:30px;max-width:580px;width:92%;max-height:86vh;overflow-y:auto}
.mtitle{font-family:'Cinzel',serif;font-size:19px;color:var(--gold);letter-spacing:2.5px;margin-bottom:4px;text-align:center}
.msub{font-family:'Crimson Pro',serif;font-size:13px;color:var(--text-muted);text-align:center;margin-bottom:22px;font-style:italic}
.mresult{text-align:center;padding:18px;border-radius:8px;margin-bottom:18px;font-family:'Cinzel',serif;font-size:17px;letter-spacing:1.5px}
.mresult.vis{background:rgba(78,205,196,.1);border:1px solid rgba(78,205,196,.4);color:var(--data-green)}
.mresult.nov{background:rgba(255,107,107,.1);border:1px solid rgba(255,107,107,.4);color:#ff6b6b}
.mresult.unc{background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.4);color:#ffd700}
.mdet{font-family:'Crimson Pro',serif;font-size:14px;line-height:1.75;color:#b8c8d4}
.mdet h4{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;color:var(--gold-dim);margin:14px 0 6px}
.crow{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:12px}
#acc-chip{position:absolute;top:10px;right:10px;font-size:7px;letter-spacing:1.5px;color:var(--data-green);border:1px solid rgba(78,205,196,.3);border-radius:3px;padding:3px 7px;background:rgba(78,205,196,.06)}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:2px}
</style>
</head>
<body>
<canvas id="c-stars"></canvas>
<canvas id="c-sky"></canvas>

<div id="ui">
<div id="hdr">
  <div>
    <div class="logo-main">â˜½ MOONSIGHT</div>
    <div class="logo-sub">Observatory-Grade Crescent Simulator Â· v3.0</div>
  </div>
  <div class="hdr-coords" id="hdr-coords">
    <div>LAT <span id="hc-lat">20.2700Â°N</span> &nbsp; LON <span id="hc-lon">85.8400Â°E</span></div>
    <div>BHUBANESWAR, ODISHA, INDIA</div>
  </div>
</div>

<div id="lpanel">
  <div class="panel">
    <div class="plabel">âŠ• Location</div>
    <div class="irow">
      <div style="flex:1"><div class="ilbl">Latitude Â°</div><input class="ifield" id="i-lat" type="number" step="0.0001" value="20.27"></div>
      <div style="flex:1"><div class="ilbl">Longitude Â°</div><input class="ifield" id="i-lon" type="number" step="0.0001" value="85.84"></div>
    </div>
    <div class="ilbl">UTC Offset (h)</div>
    <input class="ifield" id="i-tz" type="number" step="0.5" value="5.5" style="margin-bottom:9px">
    <div class="presets">
      <button class="btn pbtn" onclick="preset('bhubaneswar')">Bhubaneswar</button>
      <button class="btn pbtn" onclick="preset('mecca')">Mecca</button>
      <button class="btn pbtn" onclick="preset('istanbul')">Istanbul</button>
      <button class="btn pbtn" onclick="preset('london')">London</button>
      <button class="btn pbtn" onclick="preset('jakarta')">Jakarta</button>
      <button class="btn pbtn" onclick="preset('cairo')">Cairo</button>
      <button class="btn pbtn" onclick="preset('karachi')">Karachi</button>
      <button class="btn pbtn" onclick="preset('tehran')">Tehran</button>
    </div>
  </div>

  <div class="panel">
    <div class="plabel">âŠ™ Date</div>
    <input class="ifield" id="i-date" type="date" style="margin-bottom:8px">
    <div class="irow">
      <button class="btn" style="flex:1" onclick="shiftDay(-1)">â—€ Day</button>
      <button class="btn" style="flex:1" onclick="gotoNewMoon()">â†» New Moon</button>
      <button class="btn" style="flex:1" onclick="shiftDay(1)">Day â–¶</button>
    </div>
    <div class="irow" style="margin-top:3px">
      <button class="btn" style="flex:1;font-size:8px" onclick="shiftDay(-7)">â—€â—€ Week</button>
      <button class="btn" style="flex:1;font-size:8px" onclick="gotoSunset()">â–¼ Sunset</button>
      <button class="btn" style="flex:1;font-size:8px" onclick="shiftDay(7)">Week â–¶â–¶</button>
    </div>
  </div>

  <div class="panel">
    <div class="plabel">â—Œ Atmospheric Clarity</div>
    <div class="atm-row">
      <button class="btn atm-btn active" id="a-clear" onclick="setAtmo('clear')">Perfect</button>
      <button class="btn atm-btn" id="a-haze"  onclick="setAtmo('haze')">Moderate</button>
      <button class="btn atm-btn" id="a-heavy" onclick="setAtmo('heavy')">Heavy</button>
    </div>
    <div class="trow"><span class="tlbl">Moon Path Arc</span><div class="tog on" id="tog-arc" onclick="togArc()"></div></div>
    <div class="trow"><span class="tlbl">Shooting Stars</span><div class="tog on" id="tog-sh" onclick="togShoot()"></div></div>
    <div class="trow"><span class="tlbl">Star Labels</span><div class="tog" id="tog-lbl" onclick="togLabels()"></div></div>
    <div class="trow"><span class="tlbl">Constellation Lines</span><div class="tog" id="tog-con" onclick="togConst()"></div></div>
    <div class="trow"><span class="tlbl">Topocentric Î” info</span><div class="tog on" id="tog-topo" onclick="togTopo()"></div></div>
  </div>

  <div class="panel">
    <div class="plabel">â—‰ New Moon Reference</div>
    <div class="nmbox">
      <div class="nmrow"><span class="nmk">NEW MOON UTC</span><span class="nmv" id="nm-utc">â€”</span></div>
      <div class="nmrow"><span class="nmk">NEW MOON LOCAL</span><span class="nmv" id="nm-loc">â€”</span></div>
      <div class="nmrow"><span class="nmk">MOON AGE</span><span class="nmv" id="nm-age">â€”</span></div>
      <div class="nmrow"><span class="nmk">TOPO CORR Î”alt</span><span class="nmv" id="nm-topo">â€”</span></div>
    </div>
    <div class="phase-wrap">
      <span style="font-size:9px;color:var(--text-muted)">NM</span>
      <div class="pbar-bg"><div class="pbar" id="pbar" style="width:0%"></div></div>
      <span style="font-size:9px;color:var(--text-muted)">FM</span>
    </div>
  </div>

  <div class="panel">
    <button class="btn btn-eid" onclick="showModal()">â˜½ Is Crescent Visible Tonight?</button>
    <div style="font-size:8px;color:var(--text-muted);text-align:center;margin-top:7px;font-family:'Crimson Pro',serif;font-style:italic">Yallop 1997 Â· Odeh 2004 Â· Topo Elongation Â· Solar Depression</div>
  </div>
</div>

<div id="rpanel">
  <div class="panel" style="position:relative">
    <div id="acc-chip">TOPO+REFR+EXTINCT</div>
    <div class="plabel">â—ˆ Astronomical Data</div>
    <div class="dgrid">
      <div class="ditem"><span class="dkey">Topo Elongation</span><span class="dval gold" id="d-elong">â€”</span></div>
      <div class="ditem"><span class="dkey">Illumination</span><span class="dval" id="d-illum">â€”</span></div>
      <div class="ditem"><span class="dkey">Moon Age</span><span class="dval" id="d-age">â€”</span></div>
      <div class="ditem"><span class="dkey">Topo Altitude</span><span class="dval green" id="d-alt">â€”</span></div>
      <div class="ditem"><span class="dkey">Azimuth</span><span class="dval" id="d-az">â€”</span></div>
      <div class="ditem"><span class="dkey">Phase</span><span class="dval" id="d-phase">â€”</span></div>
      <div class="ditem"><span class="dkey">Sunset (local)</span><span class="dval gold" id="d-ss">â€”</span></div>
      <div class="ditem"><span class="dkey">Moonset (local)</span><span class="dval" id="d-ms">â€”</span></div>
      <div class="ditem"><span class="dkey">Lag Time</span><span class="dval" id="d-lag">â€”</span></div>
      <div class="ditem"><span class="dkey">ARCV (topo)</span><span class="dval gold" id="d-arcv">â€”</span></div>
      <div class="ditem"><span class="dkey">Crescent W</span><span class="dval" id="d-W">â€”</span></div>
      <div class="ditem"><span class="dkey">Yallop q</span><span class="dval" id="d-q">â€”</span></div>
      <div class="ditem"><span class="dkey">Odeh V</span><span class="dval" id="d-V">â€”</span></div>
      <div class="ditem"><span class="dkey">Airmass (Moon)</span><span class="dval" id="d-am">â€”</span></div>
      <div class="ditem"><span class="dkey">Extinction Î”mag</span><span class="dval" id="d-ext">â€”</span></div>
      <div class="ditem"><span class="dkey">Sun Altitude</span><span class="dval" id="d-sa">â€”</span></div>
      <div class="ditem"><span class="dkey">Best View Time</span><span class="dval green" id="d-bvt">â€”</span></div>
    </div>
  </div>
  <div class="panel" id="vbadge">
    <div class="vb-lbl">Visibility Classification</div>
    <div class="vb-txt" id="vb-txt" style="color:var(--text-muted)">CALCULATINGâ€¦</div>
    <div class="vb-prob" id="vb-prob">â€”</div>
  </div>
</div>

<div id="bpanel">
  <div>
    <div class="tdisp" id="tdisp">00:00 UTC</div>
    <div class="tsub" id="tsub">â€”</div>
  </div>
  <div class="cbtns">
    <div class="cbtn" onclick="stepMin(-60)" title="-1h">âŸª</div>
    <div class="cbtn" onclick="stepMin(-1)"  title="-1m">â€¹</div>
    <div class="cbtn cbtn-lg" id="playbtn" onclick="togglePlay()">â–¶</div>
    <div class="cbtn" onclick="stepMin(1)"   title="+1m">â€º</div>
    <div class="cbtn" onclick="stepMin(60)"  title="+1h">âŸ«</div>
  </div>
  <!-- FIX: slider now represents LOCAL minutes-of-day (0=local midnight) -->
  <input type="range" id="tslider" min="0" max="1439" value="720" oninput="sliderInput(this.value)">
  <div style="display:flex;gap:4px">
    <button class="btn" style="font-size:8px" onclick="setSpd(1)">1Ã—</button>
    <button class="btn" style="font-size:8px" onclick="setSpd(60)">60Ã—</button>
    <button class="btn" style="font-size:8px" onclick="setSpd(300)">300Ã—</button>
  </div>
</div>
</div>

<div id="modal">
  <div class="mpanel">
    <div class="mtitle">â˜½ Crescent Visibility Analysis</div>
    <div class="msub">Observatory-Grade Â· Topocentric Elongation Â· Solar Depression Â· Bennett Refraction</div>
    <div class="mresult" id="mr-box">ASSESSINGâ€¦</div>
    <div class="mdet" id="mr-det"></div>
    <div style="margin-top:22px;text-align:center">
      <button class="btn" onclick="document.getElementById('modal').classList.remove('show')">âœ• Close</button>
    </div>
  </div>
</div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOONSIGHT v3 â€” Full Astronomical Engine (All Bugs Fixed)
//  FIX LOG:
//  1. topoCorrect() â€” radian consistency (u from Math.atan is radians,
//     was wrongly passed through *R2D back to Math.sin/cos)
//  2. bennetRefraction() â€” tan() wrapper is degree-based, removed
//     spurious *D2R inside call
//  3. Topocentric elongation â€” use topoSS.ra/dec not mSS.ra/dec
//     for Yallop q, Odeh V, crescent width W (mixed-frame fix)
//  4. assess() â€” solar depression gate: âˆ’5Â° to âˆ’12Â° optimal window
//  5. findBestVisibilityTime() â€” peak ARCV scan (replaces first-prob)
//  6. projectAz() â€” single canonical projection, used by ALL renderers
//  7. Arc cache rendering â€” now uses projectAz() (was different formula)
//  8. Compass labels â€” now uses projectAz()
//  9. sliderInput() â€” slider is LOCAL minutes, convert to UTC on input
// 10. updateUI() slider readback â€” set to local minutes
// 11. gotoNewMoon() â€” hardcoded S.hour=18 was local; now stores UTC
// 12. findRiseSet() prevAlt â€” was storing diff (alt-target),
//     then comparing pd=prevAlt-target which double-subtracted target
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const D2R=Math.PI/180, R2D=180/Math.PI;
const norm360=a=>((a%360)+360)%360;
// Degree-based trig wrappers
const sin=a=>Math.sin(a*D2R), cos=a=>Math.cos(a*D2R), tan=a=>Math.tan(a*D2R);
const asin=v=>Math.asin(v)*R2D, acos=v=>Math.acos(v)*R2D, atan2=(y,x)=>Math.atan2(y,x)*R2D;

// â”€â”€ Julian Day â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function jd(yr,mo,dy,h=0,m=0,s=0){
  let Y=yr,M=mo,D=dy+(h+m/60+s/3600)/24;
  if(M<=2){Y--;M+=12;}
  const A=Math.floor(Y/100),B=2-A+Math.floor(A/4);
  return Math.floor(365.25*(Y+4716))+Math.floor(30.6001*(M+1))+D+B-1524.5;
}
function jd2cal(jd0){
  const Z=Math.floor(jd0+.5),F=jd0+.5-Z;
  let A=Z;
  if(Z>=2299161){const a=Math.floor((Z-1867216.25)/36524.25);A=Z+1+a-Math.floor(a/4);}
  const B=A+1524,C=Math.floor((B-122.1)/365.25),D=Math.floor(365.25*C),E=Math.floor((B-D)/30.6001);
  const day=B-D-Math.floor(30.6001*E);
  const month=E<14?E-1:E-13;
  const year=month>2?C-4716:C-4715;
  const h=F*24,hh=Math.floor(h),mm=Math.floor((h-hh)*60);
  return{year,month,day,hour:hh,min:mm};
}
const Tc=jd0=>(jd0-2451545)/36525;

// â”€â”€ NUTATION (IAU 1980, 20 dominant terms) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NUT_TERMS=[
  [0,0,0,0,1,-171996,-174.2,92025,8.9],[-2,0,0,2,2,-13187,-1.6,5736,-3.1],
  [0,0,0,2,2,-2274,-0.2,977,-0.5],[0,0,0,0,2,2062,0.2,-895,0.5],
  [0,1,0,0,0,1426,-3.4,54,-0.1],[0,0,1,0,0,712,0.1,-7,0],
  [-2,1,0,2,2,-517,1.2,224,-0.6],[0,0,0,2,1,-386,-0.4,200,0],
  [0,0,1,2,2,-301,0,129,-0.1],[-2,-1,0,2,2,217,-0.5,-95,0.3],
  [-2,0,1,0,0,-158,0,0,0],[-2,0,0,2,1,129,0.1,-70,0],
  [0,0,-1,2,2,123,0,-53,0],[2,0,0,0,0,63,0,0,0],
  [0,0,1,0,1,63,0.1,-33,0],[2,0,-1,2,2,-59,0,26,0],
  [0,0,-1,0,1,-58,-0.1,32,0],[0,0,1,2,1,-51,0,27,0],
  [-2,0,2,0,0,48,0,0,0],[0,0,-2,2,1,46,0,-24,0],
];
function nutation(jd0){
  const t=Tc(jd0);
  const D=norm360(297.85036+445267.111480*t-0.0019142*t*t+t*t*t/189474);
  const M=norm360(357.52772+35999.050340*t-0.0001603*t*t-t*t*t/300000);
  const Mp=norm360(134.96298+477198.867398*t+0.0086972*t*t+t*t*t/56250);
  const F=norm360(93.27191+483202.017538*t-0.0036825*t*t+t*t*t/327270);
  const Om=norm360(125.04452-1934.136261*t+0.0020708*t*t+t*t*t/450000);
  let dpsi=0,deps=0;
  for(const[d,m,mp,f,om,p0,p1,e0,e1] of NUT_TERMS){
    const arg=d*D+m*M+mp*Mp+f*F+om*Om;
    dpsi+=(p0+p1*t)*sin(arg); deps+=(e0+e1*t)*cos(arg);
  }
  return{dpsi:dpsi/36e6,deps:deps/36e6};
}

function obliquity(jd0){
  const t=Tc(jd0)/100;
  const e0=23+26/60+21.448/3600-(4680.93/3600)*t-(1.55/3600)*t*t+(1999.25/3600)*t*t*t
           -(51.38/3600)*t*t*t*t-(249.67/3600)*t*t*t*t*t;
  return e0+nutation(jd0).deps;
}

// â”€â”€ SUN POSITION (VSOP87 abridged, Meeus Ch.25) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sunPos(jd0){
  const t=Tc(jd0);
  const L0=norm360(280.46646+36000.76983*t+0.0003032*t*t);
  const M=norm360(357.52911+35999.05029*t-0.0001537*t*t);
  const C=(1.914602-0.004817*t-0.000014*t*t)*sin(M)+(0.019993-0.000101*t)*sin(2*M)+0.000289*sin(3*M);
  const sLon=L0+C;
  const{dpsi}=nutation(jd0);
  const Om=125.04-1934.136*t;
  const appLon=sLon+dpsi-0.00569-0.00478*sin(Om);
  const eps=obliquity(jd0);
  const ra=norm360(atan2(cos(eps)*sin(appLon),cos(appLon)));
  const dec=asin(sin(eps)*sin(appLon));
  return{lon:norm360(appLon),ra,dec,trueLon:norm360(sLon)};
}

// â”€â”€ MOON POSITION (ELP-2000/82, Meeus Ch.47, 60+30 terms) â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LR=[
  [0,0,1,0,6288774,-20905355],[2,0,-1,0,1274027,-3699111],[2,0,0,0,658314,-2955968],
  [0,0,2,0,213618,-569925],[0,1,0,0,-185116,48888],[0,0,0,2,-114332,-3149],
  [2,0,-2,0,58793,246158],[2,-1,-1,0,57066,-152138],[2,0,1,0,53322,-170733],
  [2,-1,0,0,45758,-204586],[0,1,-1,0,-40923,-129620],[1,0,0,0,-34720,108743],
  [0,1,1,0,-30383,104755],[2,0,0,-2,15327,10321],[0,0,1,2,-12528,0],
  [0,0,1,-2,10980,79661],[4,0,-1,0,10675,-34782],[0,0,3,0,10034,-23210],
  [4,0,-2,0,8548,-21636],[2,1,-1,0,-7888,24208],[2,1,0,0,-6766,30824],
  [1,0,-1,0,-5163,-8379],[1,1,0,0,4987,-16675],[2,-1,1,0,4036,-12831],
  [2,0,2,0,3994,-10445],[4,0,0,0,3861,-11650],[2,0,-3,0,3665,14403],
  [0,1,-2,0,-2689,-7003],[2,0,-1,2,-2602,0],[2,-1,-2,0,2390,10056],
  [1,0,1,0,-2348,6322],[2,-2,0,0,2236,-9884],[0,1,2,0,-2120,5751],
  [0,2,0,0,-2069,0],[2,-2,-1,0,2048,-4950],[2,0,1,-2,-1773,4130],
  [2,0,0,2,-1595,0],[4,-1,-1,0,1215,-3958],[0,0,2,2,-1110,0],
  [3,0,-1,0,-892,3258],[2,1,1,0,-810,2616],[4,-1,-2,0,759,-1897],
  [0,2,-1,0,-713,-2117],[2,2,-1,0,-700,2354],[2,1,-2,0,691,0],
  [2,-1,0,-2,596,0],[4,0,1,0,549,-1423],[0,0,4,0,537,-1117],
  [4,-1,0,0,520,-1571],[1,0,-2,0,-487,-1739],[2,1,0,-2,-399,0],
  [0,0,2,-2,-381,-4421],[1,1,1,0,351,0],[3,0,-2,0,-340,0],
  [4,0,-3,0,330,0],[2,-1,2,0,327,0],[0,2,1,0,-323,1165],
  [1,1,-1,0,299,0],[2,0,3,0,294,0],[2,0,-1,-2,0,8752],
];
const BL=[
  [0,0,0,1,5128122],[0,0,1,1,280602],[0,0,1,-1,277693],[2,0,0,-1,173237],
  [2,0,-1,1,55413],[2,0,-1,-1,46271],[2,0,0,1,32573],[0,0,2,1,17198],
  [2,0,1,-1,9266],[0,0,2,-1,8822],[2,-1,0,-1,8216],[2,0,-2,-1,4324],
  [2,0,1,1,4200],[2,1,0,-1,-3359],[2,-1,-1,1,2463],[2,-1,0,1,2211],
  [2,-1,-1,-1,2065],[0,1,-1,-1,-1870],[4,0,-1,-1,1828],[0,1,0,1,-1794],
  [0,0,0,3,-1749],[0,1,-1,1,-1565],[1,0,0,1,-1491],[0,1,1,1,-1475],
  [0,1,1,-1,-1410],[0,1,0,-1,-1344],[1,0,0,-1,-1335],[0,0,3,1,1107],
  [4,0,0,-1,1021],[4,0,-1,1,833],
];
function moonPos(jd0){
  const t=Tc(jd0);
  const Lp=norm360(218.3164477+481267.88123421*t-0.0015786*t*t+t*t*t/538841-t*t*t*t/65194000);
  const D=norm360(297.8501921+445267.1114034*t-0.0018819*t*t+t*t*t/545868-t*t*t*t/113065000);
  const M=norm360(357.5291092+35999.0502909*t-0.0001536*t*t+t*t*t/24490000);
  const Mp=norm360(134.9633964+477198.8675055*t+0.0087414*t*t+t*t*t/69699-t*t*t*t/14712000);
  const F=norm360(93.2720950+483202.0175233*t-0.0036539*t*t-t*t*t/3526000+t*t*t*t/863310000);
  const Om=norm360(125.0445479-1934.1362608*t+0.0020754*t*t+t*t*t/467441-t*t*t*t/60616000);
  const A1=norm360(119.75+131.849*t),A2=norm360(53.09+479264.290*t),A3=norm360(313.45+481266.484*t);
  const E=1-0.002516*t-0.0000074*t*t,E2=E*E;
  let SL=0,Sr=0,Sb=0;
  for(const[d,m,mp,f,sl,sr] of LR){
    const arg=d*D+m*M+mp*Mp+f*F,ec=Math.abs(m)===1?E:Math.abs(m)===2?E2:1;
    SL+=ec*sl*sin(arg); Sr+=ec*sr*cos(arg);
  }
  for(const[d,m,mp,f,sb] of BL){
    const arg=d*D+m*M+mp*Mp+f*F,ec=Math.abs(m)===1?E:Math.abs(m)===2?E2:1;
    Sb+=ec*sb*sin(arg);
  }
  SL+=3958*sin(A1)+1962*sin(Lp-F)+318*sin(A2);
  Sb+=-2235*sin(Lp)+382*sin(A3)+175*sin(A1-F)+175*sin(A1+F)+127*sin(Lp-Mp)-115*sin(Lp+Mp);
  const{dpsi}=nutation(jd0);
  const lon=norm360(Lp+SL/1e6+dpsi);
  const lat=Sb/1e6;
  const dist=385000.56+Sr/1e3;
  const eps=obliquity(jd0);
  const ra=norm360(atan2(cos(eps)*sin(lon)-tan(lat)*sin(eps),cos(lon)));
  const dec=asin(sin(lat)*cos(eps)+cos(lat)*sin(eps)*sin(lon));
  return{lon,lat,dist,ra,dec};
}

// â”€â”€ LOCAL SIDEREAL TIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lst(jd0,lon){
  const t=Tc(jd0);
  const theta=280.46061837+360.98564736629*(jd0-2451545)+0.000387933*t*t-t*t*t/38710000;
  const{dpsi}=nutation(jd0);
  const eqEq=dpsi*cos(obliquity(jd0));
  return norm360(theta+lon+eqEq);
}

// â”€â”€ EQUATORIAL â†’ HORIZONTAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eq2hor(ra,dec,LST,lat){
  const H=norm360(LST-ra);
  const alt=asin(sin(lat)*sin(dec)+cos(lat)*cos(dec)*cos(H));
  const az=norm360(atan2(sin(H),cos(H)*sin(lat)-tan(dec)*cos(lat))+180);
  return{alt,az,H};
}

// â”€â”€ TOPOCENTRIC CORRECTION (Meeus Ch.40) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX 1: u from Math.atan() is radians â€” must use Math.sin(u)/Math.cos(u),
//         NOT sin(u) [which is the degree wrapper] or Math.sin(u*R2D).
//         Old code had Math.sin(u*R2D) which converted radians â†’ degrees
//         then passed to Math.sin â†’ completely wrong values.
function topoCorrect(ra,dec,dist_km,LST,lat,elev_m=0){
  const latRad=lat*D2R;
  const Hrad=norm360(LST-ra)*D2R;               // hour angle in radians
  const sinPi=Math.asin(6378.14/dist_km);        // horizontal parallax (radians)

  // Geocentric latitude auxiliary angle (Meeus 11.1) â€” result is radians
  const u=Math.atan(0.99664719*Math.tan(latRad));
  // rho components â€” u is in radians, use Math.sin/cos directly
  const rhoSinPhi=0.99664719*Math.sin(u)+(elev_m/6378140)*Math.sin(latRad);
  const rhoCosPhi=Math.cos(u)+(elev_m/6378140)*Math.cos(latRad);

  const decRad=dec*D2R;
  const sinPiV=Math.sin(sinPi); // sin(horizontal parallax)

  // Î”Î± in radians (Meeus 40.6)
  const dRA_rad=Math.atan2(
    -rhoCosPhi*sinPiV*Math.sin(Hrad),
    Math.cos(decRad)-rhoCosPhi*sinPiV*Math.cos(Hrad)
  );

  // Topocentric declination (Meeus 40.7)
  const decT_rad=Math.atan2(
    (Math.sin(decRad)-rhoSinPhi*sinPiV)*Math.cos(dRA_rad),
    Math.cos(decRad)-rhoCosPhi*sinPiV*Math.cos(Hrad)
  );

  const raT=norm360(ra+dRA_rad*R2D);
  const decT=decT_rad*R2D;
  return{ra:raT, dec:decT, dRA:dRA_rad*R2D, dDec:decT-dec};
}

// â”€â”€ BENNETT REFRACTION (Bennett 1982, Meeus Ch.16) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX 2: tan() is a degree-wrapper (tan(a)=Math.tan(a*D2R)).
//         Old code: tan((alt+...)*D2R) â€” double-converted to radians.
//         Correct: tan(alt+...) â€” the wrapper handles the D2R.
function bennetRefraction(alt_app){
  if(alt_app<-0.5) return 0;
  // alt_app is in degrees; tan() wrapper converts internally
  const R=1.02/(60*tan(alt_app+10.3/(alt_app+5.11)));
  return Math.max(0,R); // degrees
}
function apparentAlt(trueAlt){
  let app=trueAlt;
  for(let i=0;i<3;i++) app=trueAlt+bennetRefraction(app);
  return app;
}

// â”€â”€ ATMOSPHERIC EXTINCTION (Schaefer 1991) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function airmass(alt){
  if(alt<-2) return 999;
  const z=90-alt;
  return 1/(cos(z)+0.025*Math.exp(-11*cos(z)));
}
function extinction(alt,clarity){
  const k=clarity==='clear'?0.20:clarity==='haze'?0.35:0.60;
  const X=airmass(alt);
  return{k,X,dV:k*X};
}
function extinctionFactor(dV){return Math.pow(10,0.4*dV);}

// â”€â”€ RISE/SET SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX 12: prevAlt was storing (appA-target) i.e. "diff", then doing
//          pd = prevAlt - target which double-subtracted target.
//          Fix: store raw appA, compare with target in sign-change check.
function findRiseSet(jdNoon,lat,lon,body,findSetting){
  const target=body==='sun'?-0.833:0.125;
  const STEPS=48;
  let prevAlt=null,prevJD=null,bestJD=null;
  for(let i=0;i<=STEPS;i++){
    const jdSamp=jdNoon-0.5+i/STEPS;
    const LST=lst(jdSamp,lon);
    let ra,dec,dist;
    if(body==='sun'){const s=sunPos(jdSamp);ra=s.ra;dec=s.dec;}
    else{const m=moonPos(jdSamp);ra=m.ra;dec=m.dec;dist=m.dist;
      const tc=topoCorrect(ra,dec,dist,LST,lat);ra=tc.ra;dec=tc.dec;}
    const{alt}=eq2hor(ra,dec,LST,lat);
    const appA=apparentAlt(alt); // store raw apparent altitude
    if(prevAlt!==null){
      if(findSetting?(prevAlt>target&&appA<=target):(prevAlt<target&&appA>=target)){
        let lo=prevJD,hi=jdSamp;
        for(let k=0;k<40;k++){
          const mid=(lo+hi)/2,L2=lst(mid,lon);
          let r2,d2,d3;
          if(body==='sun'){const s=sunPos(mid);r2=s.ra;d2=s.dec;}
          else{const m=moonPos(mid);r2=m.ra;d2=m.dec;d3=m.dist;
            const tc=topoCorrect(r2,d2,d3,L2,lat);r2=tc.ra;d2=tc.dec;}
          const aa=apparentAlt(eq2hor(r2,d2,L2,lat).alt);
          if(findSetting?aa>target:aa<target) lo=mid; else hi=mid;
        }
        bestJD=(lo+hi)/2; break;
      }
    }
    prevAlt=appA; prevJD=jdSamp;
  }
  return bestJD||jdNoon+(findSetting?0.25:-0.25);
}

// â”€â”€ ELONGATION & ILLUMINATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function elongation(mRA,mDec,sRA,sDec){
  return acos(sin(sDec)*sin(mDec)+cos(sDec)*cos(mDec)*cos(mRA-sRA));
}
function illumination(elong){return(1-cos(elong))/2*100;}

// â”€â”€ CRESCENT WIDTH (Schaefer 1988) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function crescentWidth(elong_deg,dist_km){
  const sd=0.27245*6378.14/dist_km*60;
  return{W:sd*(1-cos(elong_deg))/2,sd};
}

// â”€â”€ BRIGHT LIMB POSITION ANGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function brightLimbPA(mRA,mDec,sRA,sDec){
  return atan2(cos(sDec)*sin(sRA-mRA),sin(sDec)*cos(mDec)-cos(sDec)*sin(mDec)*cos(sRA-mRA));
}

// â”€â”€ YALLOP q-CRITERION (1997) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function yallop(arcv,W){return arcv-(11.8371-6.3226*W+0.7319*W*W-0.1018*W*W*W);}
function yallopClass(q){
  if(q>0.216)  return{cls:'A',label:'Easily Visible',prob:100,color:'#4ecdc4'};
  if(q>-0.014) return{cls:'B',label:'Visible (opt aid confirmable)',prob:88,color:'#74b9ff'};
  if(q>-0.160) return{cls:'C',label:'May Need Optical Aid',prob:65,color:'#a8edea'};
  if(q>-0.232) return{cls:'D',label:'Optical Aid Only',prob:40,color:'#ffa07a'};
  if(q>-0.293) return{cls:'E',label:'Extremely Difficult',prob:15,color:'#ffd700'};
  return{cls:'F',label:'Not Visible',prob:0,color:'#ff6b6b'};
}

// â”€â”€ ODEH V-CRITERION (2004) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function odeh(arcv,W){return arcv-(7.1651-6.3226*W+0.7319*W*W-0.1018*W*W*W);}
function odehClass(V){
  if(V>=5.65)  return{label:'Naked Eye',prob:100,color:'#4ecdc4'};
  if(V>=2.00)  return{label:'Optical Aid Possible',prob:70,color:'#74b9ff'};
  if(V>=-0.96) return{label:'Difficult Optical',prob:35,color:'#ffa07a'};
  return{label:'Not Visible',prob:0,color:'#ff6b6b'};
}

const danjon=elong=>elong>7.5;

// â”€â”€ PHASE NAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function phaseName(moonLon,sunLon){
  const d=norm360(moonLon-sunLon);
  if(d<11.25)  return'ğŸŒ‘ New Moon';
  if(d<78.75)  return'ğŸŒ’ Waxing Crescent';
  if(d<101.25) return'ğŸŒ“ First Quarter';
  if(d<168.75) return'ğŸŒ” Waxing Gibbous';
  if(d<191.25) return'ğŸŒ• Full Moon';
  if(d<258.75) return'ğŸŒ– Waning Gibbous';
  if(d<281.25) return'ğŸŒ— Last Quarter';
  if(d<348.75) return'ğŸŒ˜ Waning Crescent';
  return'ğŸŒ‘ New Moon';
}

// â”€â”€ NEW MOON FINDER (Meeus Ch.49) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newMoonK(kk){
  const T0=kk/1236.85;
  let J=2451550.09766+29.530588861*kk+0.00015437*T0*T0-0.000000150*T0*T0*T0+0.00000000073*T0*T0*T0*T0;
  const M=norm360(2.5534+29.10535670*kk-0.0000014*T0*T0),Mr=M*D2R;
  const Mp=norm360(201.5643+385.81693528*kk+0.0107582*T0*T0+0.00001238*T0*T0*T0),Mpr=Mp*D2R;
  const F=norm360(160.7108+390.67050284*kk-0.0016118*T0*T0),Fr=F*D2R;
  const Om=norm360(124.7746-1.56375588*kk+0.0020672*T0*T0),Omr=Om*D2R;
  const E=1-0.002516*T0-0.0000074*T0*T0;
  J+=-0.40720*Math.sin(Mpr)+0.17241*E*Math.sin(Mr)+0.01608*Math.sin(2*Mpr)
     +0.01039*Math.sin(2*Fr)+0.00739*E*Math.sin(Mpr-Mr)-0.00514*E*Math.sin(Mpr+Mr)
     +0.00208*E*E*Math.sin(2*Mr)-0.00111*Math.sin(Mpr-2*Fr)-0.00057*Math.sin(Mpr+2*Fr)
     +0.00056*E*Math.sin(2*Mpr+Mr)-0.00042*Math.sin(3*Mpr)+0.00042*E*Math.sin(Mr+2*Fr)
     +0.00038*E*Math.sin(Mr-2*Fr)-0.00024*E*Math.sin(2*Mpr-Mr)-0.00017*Math.sin(Omr)
     -0.00007*Math.sin(Mpr+2*Mr)+0.00004*Math.sin(2*Mpr-2*Fr)+0.00004*Math.sin(3*Mr)
     +0.00003*Math.sin(Mpr+Mr-2*Fr)+0.00003*Math.sin(2*Mpr+2*Fr)-0.00003*Math.sin(Mpr+Mr+2*Fr)
     +0.00003*Math.sin(Mpr-Mr+2*Fr)-0.00002*Math.sin(Mpr-Mr-2*Fr)-0.00002*Math.sin(3*Mpr+Mr)
     +0.00002*Math.sin(4*Mpr);
  return J;
}
function findNewMoon(jd0){
  const d=jd2cal(jd0);
  const yr=d.year+(d.month-1)/12+(d.day-1)/365.25;
  let k=Math.round((yr-2000)*12.3685);
  for(let dk=-2;dk<=2;dk++){
    const J=newMoonK(k+dk),J2=newMoonK(k+dk+1);
    if(J<=jd0&&J2>jd0) return{jd:J,jdNext:J2,k:k+dk};
  }
  return{jd:newMoonK(k),jdNext:newMoonK(k+1),k};
}

// â”€â”€ VISIBILITY ASSESSMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX 4: Added solar depression penalty.
// Optimal crescent contrast window: sun -7Â° to -9Â° (Schaefer 1988).
// Sun above -5Â°: sky too bright â†’ heavy penalty.
// Sun below -12Â°: nautical twilight, moon likely too low â†’ penalty.
function assess(elong_deg,moonAlt,sunAlt,W,moonAge,clarity){
  const arcv=moonAlt-sunAlt;
  const q=yallop(arcv,W);
  const V=odeh(arcv,W);
  const yc=yallopClass(q);
  const oc=odehClass(V);
  const ext=extinction(moonAlt,clarity);
  const extPen=Math.min(80,ext.dV*18);
  const atmoPen=clarity==='clear'?0:clarity==='haze'?15:38;

  // Solar depression penalty
  // Best window: sunAlt -7Â° to -9Â°. Outside that, apply graded penalty.
  let depPen=0;
  if(sunAlt>-5){
    // Sky still very bright: strong penalty proportional to how high sun is
    depPen=Math.min(60,(sunAlt+5)*12); // 0 at -5Â°, +60 at 0Â°
  } else if(sunAlt<-12){
    // Past nautical twilight: moon likely too low to still be above horizon
    depPen=Math.min(40,(-(sunAlt+12))*5); // 0 at -12Â°, +40 at -20Â°
  }

  let prob=yc.prob;
  prob-=extPen+atmoPen+depPen;
  if(!danjon(elong_deg)) prob=0;
  if(moonAlt<0.5) prob=0;
  if(moonAge<12) prob=0;
  prob=Math.max(0,Math.min(100,prob));

  let label,color;
  if(!danjon(elong_deg)||moonAlt<0.5||prob===0){label='IMPOSSIBLE';color='#ff6b6b';}
  else if(prob>=85){label='NAKED-EYE VISIBLE';color='#4ecdc4';}
  else if(prob>=60){label='EASILY VISIBLE';color='#a8edea';}
  else if(prob>=30){label='OPTICAL AID NEEDED';color='#ffa07a';}
  else if(prob>5){label='EXTREMELY DIFFICULT';color='#ffd700';}
  else{label='NOT VISIBLE';color='#ff6b6b';}
  return{q,V,arcv,yc,oc,ext,prob,label,color,depPen};
}

// â”€â”€ BEST VISIBILITY TIME (peak ARCV in depression window) â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX 5: Replaces "first prob>50" with "peak ARCV in -5Â° to -12Â° window"
// Scans 0â€“90 min post-sunset, finds moment of maximum ARCV where
// solar depression is within the optimal contrast window.
function findBestVisibilityTime(sunsetJD,lat,lon,nmJD){
  let bestJD=null, bestARCV=-999, bestProb=0;
  const moonAge0=(sunsetJD-nmJD)*24;
  for(let i=0;i<=90;i++){
    const testJD=sunsetJD+i/1440;
    const sunT=sunPos(testJD);
    const moonT=moonPos(testJD);
    const L=lst(testJD,lon);
    const tc=topoCorrect(moonT.ra,moonT.dec,moonT.dist,L,lat);
    const mH=eq2hor(tc.ra,tc.dec,L,lat);
    const sH=eq2hor(sunT.ra,sunT.dec,L,lat);
    const mAlt=apparentAlt(mH.alt);
    const sAlt=apparentAlt(sH.alt);
    if(mAlt<0.5) continue;            // moon below horizon
    if(sAlt>-3) continue;             // too bright
    if(sAlt<-14) break;               // past any reasonable window
    const arcv=mAlt-sAlt;
    // Weight by solar depression quality: peak at -8Â°
    const depWeight=1-Math.abs(sAlt+8)/6; // 1.0 at -8Â°, 0 at -2Â° or -14Â°
    const score=arcv*Math.max(0.1,depWeight);
    if(score>bestARCV){
      bestARCV=score;
      bestJD=testJD;
      // Quick prob estimate for display
      const elongT=elongation(tc.ra,tc.dec,sunT.ra,sunT.dec);
      const{W}=crescentWidth(elongT,moonT.dist);
      const moonAgeT=moonAge0+i/60;
      const v=assess(elongT,mAlt,sAlt,W,moonAgeT,S.atmo);
      bestProb=v.prob;
    }
  }
  return bestJD?{jd:bestJD,prob:bestProb}:null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HIPPARCOS SUBSET (110 brightest, J2000) [RAÂ°, DecÂ°, Vmag, K, name]
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STARS_CAT=[
  [101.289,-16.716,-1.46,9900,'Sirius'],[95.988,7.407,0.45,3800,'Betelgeuse'],
  [279.234,38.783,0.03,9600,'Vega'],[97.645,16.508,0.08,8500,'Procyon'],
  [310.358,45.280,0.12,7600,'Deneb'],[83.822,-5.391,0.18,26000,'Rigel'],
  [88.793,7.407,0.45,3800,'Betelgeuse2'],[114.826,5.228,0.37,8900,'Pollux'],
  [79.172,45.998,0.08,3700,'Capella'],[24.429,-57.237,0.50,12100,'Achernar'],
  [186.649,-63.099,0.77,15000,'Acrux'],[247.352,-26.432,0.96,3100,'Antares'],
  [152.093,11.967,1.35,4200,'Regulus'],[213.915,19.182,0.98,4600,'Arcturus'],
  [201.298,-11.161,1.04,8300,'Spica'],[68.980,16.510,0.87,3800,'Aldebaran'],
  [262.608,-37.104,1.79,3200,'Shaula'],[177.265,14.572,2.14,9800,'Denebola'],
  [291.368,-9.382,0.76,10000,'Altair'],[303.868,40.257,1.25,9900,'Sadr'],
  [113.650,31.888,1.93,6500,'Castor'],[113.649,28.026,1.16,4900,'Pollux2'],
  [191.930,-59.689,0.61,24000,'Beta Crucis'],[187.792,-57.113,1.59,27000,'Gamma Crucis'],
  [138.300,-69.717,1.67,7800,'Delta Velorum'],[79.172,45.998,0.08,3700,'Cap2'],
  [344.413,15.206,2.06,9400,'Alpheratz'],[10.897,56.537,2.27,7600,'Caph'],
  [116.329,28.026,1.14,4900,'Alhena'],[90.636,6.349,1.64,12000,'Mintaka'],
  [81.283,6.349,1.69,13000,'Bellatrix'],[84.411,-1.202,1.74,30000,'Alnitak'],
  [84.053,-1.202,1.70,27000,'Alnilam'],[85.189,-1.947,2.23,22000,'Mintaka2'],
  [82.061,-3.699,2.06,10500,'Saiph'],[168.527,20.524,1.98,4900,'Zosma'],
  [193.507,55.959,1.86,9700,'Alkaid'],[200.981,54.925,2.27,3700,'Mizar'],
  [193.507,55.959,1.86,9700,'Alkaid2'],[165.932,61.751,1.77,4200,'Alioth'],
  [206.885,49.313,1.86,3100,'Dubhe'],[183.857,57.033,1.79,4400,'Merak'],
  [10.127,29.090,2.06,3800,'Mirach'],[28.660,20.808,2.06,9400,'Hamal'],
  [335.026,57.815,2.24,3900,'Ruchbah'],[21.454,60.235,2.23,6700,'Schedar'],
  [1.579,59.150,2.68,8300,'Caph2'],[357.849,63.670,3.35,7000,'Segin'],
  [150.003,11.967,1.35,4200,'Ras Elased'],[116.329,28.026,1.14,4900,'Alh2'],
  [152.093,11.967,1.35,4200,'Reg2'],[218.877,38.308,2.65,4000,'Izar'],
  [220.482,40.390,3.05,8800,'Seginus'],[337.821,-0.117,2.96,4200,'Sadalsuud'],
  [322.890,-9.875,2.90,4400,'Sadalmelik'],[340.651,-1.387,3.10,7600,'Ancha'],
  [344.413,15.206,2.06,9400,'Alp2'],[24.429,15.183,3.86,4700,'Sheratan'],
  [354.837,77.633,2.51,5700,'Errai'],[346.190,28.083,2.83,3800,'Algenib'],
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={
  lat:20.27,lon:85.84,tz:5.5,
  year:2025,month:1,day:1,hour:19,min:0,
  currentJD:0,playing:false,speed:60,atmo:'clear',
  showArc:true,showShoot:true,showLabels:false,showConst:false,showTopo:true,
  cache:null,arcCache:null,newMoonJD:0,
};
const PRESETS2={
  bhubaneswar:{lat:20.27,lon:85.84,tz:5.5,name:'Bhubaneswar, Odisha, India'},
  mecca:{lat:21.39,lon:39.86,tz:3,name:'Mecca, Saudi Arabia'},
  istanbul:{lat:41.01,lon:28.98,tz:3,name:'Istanbul, Turkey'},
  london:{lat:51.51,lon:-0.13,tz:1,name:'London, UK'},
  jakarta:{lat:-6.21,lon:106.85,tz:7,name:'Jakarta, Indonesia'},
  cairo:{lat:30.04,lon:31.24,tz:2,name:'Cairo, Egypt'},
  karachi:{lat:24.86,lon:67.01,tz:5,name:'Karachi, Pakistan'},
  tehran:{lat:35.69,lon:51.39,tz:3.5,name:'Tehran, Iran'},
};

function preset(k){
  const p=PRESETS2[k];
  S.lat=p.lat; S.lon=p.lon; S.tz=p.tz;
  document.getElementById('i-lat').value=p.lat;
  document.getElementById('i-lon').value=p.lon;
  document.getElementById('i-tz').value=p.tz;
  document.getElementById('hdr-coords').innerHTML=
    `<div>LAT <span>${Math.abs(p.lat).toFixed(4)}Â°${p.lat>=0?'N':'S'}</span> &nbsp; LON <span>${Math.abs(p.lon).toFixed(4)}Â°${p.lon>=0?'E':'W'}</span></div><div>${p.name.toUpperCase()}</div>`;
  S.arcCache=null; recalculate();
}

function initDate(){
  const n=new Date();
  S.year=n.getUTCFullYear(); S.month=n.getUTCMonth()+1; S.day=n.getUTCDate();
  S.hour=n.getUTCHours(); S.min=n.getUTCMinutes();
  document.getElementById('i-date').value=dateStr();
  updateJD();
}
function dateStr(){
  return`${S.year}-${String(S.month).padStart(2,'0')}-${String(S.day).padStart(2,'0')}`;
}
function updateJD(){
  // S.hour/S.min are always UTC â€” jd() receives UTC values directly
  S.currentJD=jd(S.year,S.month,S.day,S.hour,S.min,0);
}
function shiftDay(d){
  const j0=jd(S.year,S.month,S.day)+d;
  const c=jd2cal(j0);
  S.year=c.year; S.month=c.month; S.day=c.day;
  document.getElementById('i-date').value=dateStr();
  S.arcCache=null; updateJD(); recalculate();
}

// FIX 11: gotoNewMoon() was hardcoding S.hour=18 (intending local 18:00)
// but S.hour must hold UTC. Now converts local 18:30 â†’ UTC properly.
function gotoNewMoon(){
  if(!S.newMoonJD) return;
  // Go to day after new moon
  const dayJD=Math.floor(S.newMoonJD+1);
  const c=jd2cal(dayJD);
  S.year=c.year; S.month=c.month; S.day=c.day;
  // Set time to local 18:30 â†’ UTC
  const localHour=18, localMin=30;
  const utcMin=(((localHour*60+localMin)-S.tz*60)%1440+1440)%1440;
  S.hour=Math.floor(utcMin/60); S.min=utcMin%60;
  document.getElementById('i-date').value=dateStr();
  S.arcCache=null; updateJD(); recalculate();
}

function gotoSunset(){
  recalculate();
  if(!S.cache) return;
  // sunsetJD is UTC â€” extract UTC y/m/d/h/m directly (no tz shift)
  const c=jd2cal(S.cache.sunsetJD);
  S.year=c.year; S.month=c.month; S.day=c.day;
  S.hour=c.hour; S.min=c.min;
  document.getElementById('i-date').value=dateStr();
  S.arcCache=null; updateJD();
  // FIX 10: slider readback in local minutes
  const locMin=(((S.hour*60+S.min)+Math.round(S.tz*60))%1440+1440)%1440;
  document.getElementById('tslider').value=locMin;
  recalculate();
}

function stepMin(m){
  const j0=S.currentJD+m/1440;
  const c=jd2cal(j0);
  S.year=c.year; S.month=c.month; S.day=c.day; S.hour=c.hour; S.min=c.min;
  document.getElementById('i-date').value=dateStr();
  updateJD(); recalculate();
}

// FIX 9: Slider represents LOCAL minutes-of-day (0=local midnight).
// Convert to UTC before storing in S.hour/S.min.
function sliderInput(v){
  const utcMin=(((+v)-Math.round(S.tz*60))%1440+1440)%1440;
  S.hour=Math.floor(utcMin/60); S.min=utcMin%60;
  updateJD(); recalculate();
}

function setAtmo(a){
  S.atmo=a;
  ['clear','haze','heavy'].forEach(x=>document.getElementById('a-'+x).classList.toggle('active',x===a));
  recalculate();
}
function togArc(){S.showArc=!S.showArc;document.getElementById('tog-arc').classList.toggle('on',S.showArc);}
function togShoot(){S.showShoot=!S.showShoot;document.getElementById('tog-sh').classList.toggle('on',S.showShoot);}
function togLabels(){S.showLabels=!S.showLabels;document.getElementById('tog-lbl').classList.toggle('on',S.showLabels);}
function togConst(){S.showConst=!S.showConst;document.getElementById('tog-con').classList.toggle('on',S.showConst);}
function togTopo(){S.showTopo=!S.showTopo;document.getElementById('tog-topo').classList.toggle('on',S.showTopo);}

document.getElementById('i-date').addEventListener('change',function(){
  const p=this.value.split('-');
  S.year=+p[0]; S.month=+p[1]; S.day=+p[2];
  S.arcCache=null; updateJD(); recalculate();
});
document.getElementById('i-lat').addEventListener('change',function(){S.lat=+this.value;S.arcCache=null;recalculate();});
document.getElementById('i-lon').addEventListener('change',function(){S.lon=+this.value;S.arcCache=null;recalculate();});
document.getElementById('i-tz').addEventListener('change',function(){S.tz=+this.value;S.arcCache=null;recalculate();});

// â”€â”€ CORE CALCULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recalculate(){
  const jd0=S.currentJD;
  const lat=S.lat, lon=S.lon;

  const sun=sunPos(jd0);
  const moon=moonPos(jd0);
  const LST=lst(jd0,lon);

  // Topocentric Moon for current time
  const topo=topoCorrect(moon.ra,moon.dec,moon.dist,LST,lat);
  const moonRA_T=topo.ra, moonDec_T=topo.dec;

  const sunH=eq2hor(sun.ra,sun.dec,LST,lat);
  const moonH=eq2hor(moonRA_T,moonDec_T,LST,lat);
  const sunAppAlt=apparentAlt(sunH.alt);
  const moonAppAlt=apparentAlt(moonH.alt);

  // FIX 3a: Use topocentric elongation for current-time display
  const elong=elongation(moonRA_T,moonDec_T,sun.ra,sun.dec);
  const illum=illumination(elong);
  const{W,sd}=crescentWidth(elong,moon.dist);
  // Bright limb tilt uses topocentric RA/Dec for visual accuracy
  const tilt=brightLimbPA(moonRA_T,moonDec_T,sun.ra,sun.dec);

  const nm=findNewMoon(jd0);
  S.newMoonJD=nm.jd;
  const moonAge=(jd0-nm.jd)*24;
  const lunarFrac=(jd0-nm.jd)/(nm.jdNext-nm.jd);

  // Sunset/moonset search (jdNoon = UTC noon for this local calendar day)
  const jdNoon=jd(S.year,S.month,S.day,12,0,0)-S.tz/24;
  const sunsetJD=findRiseSet(jdNoon,lat,lon,'sun',true);
  const moonsetJD=findRiseSet(jdNoon,lat,lon,'moon',true);
  const lagMin=(moonsetJD-sunsetJD)*1440;

  // Positions at sunset for Yallop/Odeh
  const mSS=moonPos(sunsetJD);
  const sSS=sunPos(sunsetJD);
  const LSTSS=lst(sunsetJD,lon);
  const topoSS=topoCorrect(mSS.ra,mSS.dec,mSS.dist,LSTSS,lat);
  const moonHSS=eq2hor(topoSS.ra,topoSS.dec,LSTSS,lat);
  const sunHSS=eq2hor(sSS.ra,sSS.dec,LSTSS,lat);
  const moonAppSS=apparentAlt(moonHSS.alt);
  const sunAppSS=apparentAlt(sunHSS.alt);

  // FIX 3b: Topocentric elongation at sunset â€” use topoSS.ra/dec NOT mSS.ra/dec
  // This ensures Yallop W, q and Odeh V are computed in the same topocentric frame
  // as the altitudes. Mixed-frame (geocentric elong + topocentric alt) was wrong.
  const elongSS=elongation(topoSS.ra,topoSS.dec,sSS.ra,sSS.dec);
  const{W:WSS}=crescentWidth(elongSS,mSS.dist);

  const ext=extinction(moonAppAlt,S.atmo);

  const vis=assess(elongSS,moonAppSS,sunAppSS,WSS,moonAge,S.atmo);

  // Best visibility time (peak ARCV in solar depression window)
  const bvt=findBestVisibilityTime(sunsetJD,lat,lon,nm.jd);

  const phase=phaseName(moon.lon,sun.lon);

  S.cache={
    sun,moon,sunH,moonH,sunAppAlt,moonAppAlt,
    moonRA_T,moonDec_T,topo,
    elong,illum,W,sd,tilt,
    nm,moonAge,lunarFrac,
    sunsetJD,moonsetJD,lagMin,
    moonHSS,sunHSS,moonAppSS,sunAppSS,WSS,elongSS,
    ext,vis,bvt,phase,LST,lat,lon,jd0,
  };
  updateUI();
}

// â”€â”€ UI UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hhmm(jd0,tz){
  const c=jd2cal(jd0+tz/24);
  return`${String(c.hour).padStart(2,'0')}:${String(c.min).padStart(2,'0')}`;
}
function hhmmSec(jd0){
  const c=jd2cal(jd0);
  return`${c.day}/${c.month}/${c.year} ${String(c.hour).padStart(2,'0')}:${String(c.min).padStart(2,'0')} UTC`;
}
function setD(id,val,cls){
  const e=document.getElementById(id);
  if(!e) return;
  e.textContent=val;
  e.className='dval'+(cls?' '+cls:'');
}
function updateUI(){
  const a=S.cache,v=a.vis,e=a.ext,tz=S.tz;
  setD('d-elong',`${a.elong.toFixed(2)}Â°`,a.elong>12?'green':a.elong>7?'yellow':'red');
  setD('d-illum',`${a.illum.toFixed(3)}%`,'');
  setD('d-age',`${Math.max(0,a.moonAge).toFixed(1)} h`,'');
  setD('d-alt',`${a.moonAppAlt.toFixed(2)}Â°`,a.moonAppAlt>5?'green':a.moonAppAlt>0?'yellow':'red');
  setD('d-az',`${a.moonH.az.toFixed(1)}Â°`,'');
  setD('d-phase',a.phase,'gold');
  setD('d-sa',`${a.sunAppAlt.toFixed(2)}Â°`,a.sunH.alt<0?'green':'red');
  setD('d-ss',hhmm(a.sunsetJD,tz),'gold');
  setD('d-ms',hhmm(a.moonsetJD,tz),'');
  setD('d-lag',`${a.lagMin.toFixed(0)} min`,a.lagMin>40?'green':a.lagMin>20?'yellow':'red');
  setD('d-arcv',`${a.vis.arcv.toFixed(2)}Â°`,a.vis.arcv>5?'green':'red');
  setD('d-W',`${a.WSS.toFixed(3)}'`,'');
  setD('d-q',`${v.q.toFixed(4)} (${v.yc.cls})`,v.q>0.216?'green':v.q>-0.160?'yellow':'red');
  setD('d-V',`${v.V.toFixed(4)}`,v.V>5.65?'green':v.V>2?'yellow':'red');
  setD('d-am',`${e.X.toFixed(2)}Ã—`,e.X<3?'green':e.X<8?'yellow':'red');
  setD('d-ext',`+${e.dV.toFixed(2)} mag`,e.dV<0.5?'green':e.dV<1.5?'yellow':'red');
  if(a.bvt){
    setD('d-bvt',hhmm(a.bvt.jd,tz),'green');
  } else {
    setD('d-bvt','â€”','');
  }

  document.getElementById('vb-txt').textContent=v.label;
  document.getElementById('vb-txt').style.color=v.color;
  document.getElementById('vb-prob').textContent=`Probability: ${v.prob.toFixed(0)}%`;

  document.getElementById('nm-utc').textContent=hhmmSec(a.nm.jd);
  const cl=jd2cal(a.nm.jd+tz/24);
  document.getElementById('nm-loc').textContent=`${String(cl.hour).padStart(2,'0')}:${String(cl.min).padStart(2,'0')} (UTC+${tz}) ${cl.day}/${cl.month}`;
  document.getElementById('nm-age').textContent=`${Math.max(0,a.moonAge).toFixed(1)} hours`;
  document.getElementById('nm-topo').textContent=`Î”alt = ${a.topo.dDec.toFixed(4)}Â°`;
  document.getElementById('pbar').style.width=Math.min(100,Math.max(0,a.lunarFrac*100))+'%';

  const utcC=jd2cal(S.currentJD);
  const locC=jd2cal(S.currentJD+tz/24);
  document.getElementById('tdisp').textContent=
    `${String(utcC.hour).padStart(2,'0')}:${String(utcC.min).padStart(2,'0')} UTC`;
  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('tsub').textContent=
    `${locC.day} ${mos[locC.month-1]} ${locC.year}  Â·  LOCAL ${String(locC.hour).padStart(2,'0')}:${String(locC.min).padStart(2,'0')}`;

  // FIX 10: slider position = LOCAL minutes-of-day
  const locMin=(((S.hour*60+S.min)+Math.round(S.tz*60))%1440+1440)%1440;
  document.getElementById('tslider').value=locMin;
}

// â”€â”€ PLAY/PAUSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let playRAF=null,playLastTS=0;
function setSpd(s){S.speed=s;}
function togglePlay(){
  S.playing=!S.playing;
  const btn=document.getElementById('playbtn');
  btn.textContent=S.playing?'â¸':'â–¶';
  btn.classList.toggle('active',S.playing);
  if(S.playing){playLastTS=performance.now();playStep();}
}
function playStep(ts=performance.now()){
  if(!S.playing) return;
  const dt=(ts-playLastTS)/1000; playLastTS=ts;
  const j0=S.currentJD+(dt*S.speed/60)/1440;
  const c=jd2cal(j0);
  S.year=c.year;S.month=c.month;S.day=c.day;S.hour=c.hour;S.min=c.min;
  if(S.day!==jd2cal(S.currentJD).day){document.getElementById('i-date').value=dateStr();S.arcCache=null;}
  updateJD();recalculate();
  playRAF=requestAnimationFrame(playStep);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERING ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cStars=document.getElementById('c-stars');
const cSky=document.getElementById('c-sky');
const ctxS=cStars.getContext('2d');
const ctxD=cSky.getContext('2d');
let starfield=[],shootingStars=[],twinklePhases=[];

function buildStarfield(W,H){
  starfield=[];twinklePhases=[];
  const rng=s=>{let x=Math.sin(s)*10000;x-=Math.floor(x);return x;};
  for(let i=0;i<1800;i++){
    const x=rng(i*3.1)*W,y=rng(i*5.7)*H*0.80;
    const r=rng(i*7.3)*1.5+0.2,b=rng(i*11.1)*0.7+0.3;
    const col=['255,255,255','255,240,220','220,235,255','255,250,240'][Math.floor(rng(i*13.7)*4)];
    starfield.push({x,y,r,b,col,tw:rng(i*17.3)*Math.PI*2,ts:0.02+rng(i*19.1)*0.05});
    twinklePhases.push(rng(i*23.7)*Math.PI*2);
  }
  for(let i=0;i<STARS_CAT.length;i++){
    const[ra,dec,vmag,,name]=STARS_CAT[i];
    const nx=((ra/360)*W*1.2)%W;
    const ny=H*0.04+((90-dec)/180)*H*0.72;
    const r=Math.max(0.3,2.5-vmag*0.5),b=Math.min(1,1.5-vmag*0.08);
    const T=STARS_CAT[i][3];
    const col=T>25000?'200,220,255':T>10000?'220,230,255':T>7500?'255,255,255':T>6000?'255,255,240':T>5000?'255,250,200':T>4000?'255,220,150':'255,180,80';
    starfield.push({x:nx,y:ny,r,b,col,tw:i*0.7,ts:0.015+i%10*0.003,name,vmag,hip:true});
    twinklePhases.push(i*1.1);
  }
  drawStaticStars(W,H);
}
function drawStaticStars(W,H){
  ctxS.clearRect(0,0,W,H);
  for(const s of starfield){
    ctxS.beginPath();ctxS.arc(s.x,s.y,s.r,0,Math.PI*2);
    ctxS.fillStyle=`rgba(${s.col},${s.b})`;ctxS.fill();
  }
}
function resize(){
  const W=window.innerWidth,H=window.innerHeight;
  cStars.width=cSky.width=W; cStars.height=cSky.height=H;
  buildStarfield(W,H);
}
window.addEventListener('resize',resize);
resize();

// â”€â”€ AZIMUTH PROJECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX 6+7+8: Single canonical function used by ALL renderers.
// Centers South (az=180) at W/2. East (az=90) at W/4. West (az=270) at 3W/4.
// Wraps correctly across 0Â°/360Â° using relative angle from South.
function projectAz(az,W){
  let rel=az-180;
  if(rel<-180) rel+=360;
  if(rel> 180) rel-=360;
  return W/2+(rel/180)*(W/2);
}

function getSkyGrad(ctx,W,H,sunAlt){
  const darkness=Math.max(0,Math.min(1,(-sunAlt-3)/15));
  const hR=Math.floor(darkness>0.5?8:lerp(55,8,Math.min(1,darkness*2)));
  const hG=Math.floor(darkness>0.5?18:lerp(38,18,Math.min(1,darkness*2)));
  const hB=Math.floor(darkness>0.5?35:lerp(75,35,Math.min(1,darkness*2)));
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'rgb(2,4,8)');g.addColorStop(0.45,'rgb(3,8,17)');
  g.addColorStop(0.72,`rgb(${hR},${hG},${hB})`);
  g.addColorStop(0.84,`rgb(${hR+14},${hG+10},${hB+8})`);
  g.addColorStop(1,'rgb(8,14,26)');
  return g;
}
function lerp(a,b,t){return a+(b-a)*t;}

let rafT=0;
function renderLoop(ts){
  rafT=ts;
  const W=cSky.width,H=cSky.height,ctx=ctxD;
  ctx.clearRect(0,0,W,H);
  const c=S.cache;
  if(!c){requestAnimationFrame(renderLoop);return;}

  const sunAlt=c.sunAppAlt,sunAz=c.sunH.az;
  const moonAlt=c.moonAppAlt,moonAz=c.moonH.az;
  const darkness=Math.max(0,Math.min(1,(-sunAlt-3)/15));
  const groundY=H*0.80;

  ctx.fillStyle=getSkyGrad(ctx,W,H,sunAlt);
  ctx.fillRect(0,0,W,H);

  const hazeA=S.atmo==='clear'?0:S.atmo==='haze'?0.18:0.42;
  if(hazeA>0){
    const hg=ctx.createLinearGradient(0,H*0.55,0,H);
    hg.addColorStop(0,'rgba(90,110,130,0)');
    hg.addColorStop(1,`rgba(90,110,130,${hazeA})`);
    ctx.fillStyle=hg;ctx.fillRect(0,0,W,H);
  }

  const starAlpha=Math.min(1,darkness*1.6);
  if(starAlpha>0.02){
    ctx.globalAlpha=starAlpha;ctx.drawImage(cStars,0,0);ctx.globalAlpha=1;
    const tT=ts*0.001;
    for(let i=1800;i<starfield.length;i++){
      const s=starfield[i];
      if(!s.hip||s.vmag>3) continue;
      const tw=0.75+Math.sin(tT*s.ts*30+s.tw)*0.25;
      const a=s.b*tw*starAlpha;
      if(s.r>1.5){
        const g=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*5);
        g.addColorStop(0,`rgba(${s.col},${a*0.6})`);g.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle=g;ctx.fillRect(s.x-s.r*5,s.y-s.r*5,s.r*10,s.r*10);
      }
      if(S.showLabels&&s.name&&s.vmag<2.5){
        ctx.fillStyle=`rgba(180,200,220,${starAlpha*0.7})`;
        ctx.font='8px Space Mono';ctx.fillText(s.name,s.x+4,s.y-4);
      }
    }
    const batchN=Math.min(200,Math.floor(starAlpha*300));
    for(let i=0;i<batchN;i++){
      const s=starfield[(Math.floor(ts/50+i*7))%1800];
      const tw=0.5+Math.sin(tT*s.ts*40+s.tw)*0.5;
      ctx.beginPath();ctx.arc(s.x,s.y,s.r*tw,0,Math.PI*2);
      ctx.fillStyle=`rgba(${s.col},${s.b*tw*starAlpha})`;ctx.fill();
    }
  }

  const CONST_LINES=[
    [[0.22,0.26],[0.24,0.29],[0.255,0.31],[0.24,0.33],[0.27,0.33],[0.26,0.36],[0.235,0.39],[0.28,0.39]],
    [[0.64,0.09],[0.67,0.12],[0.70,0.10],[0.73,0.12],[0.76,0.09]],
    [[0.38,0.17],[0.42,0.15],[0.46,0.16],[0.51,0.19],[0.55,0.17],[0.59,0.14],[0.63,0.16]],
    [[0.54,0.55],[0.56,0.52],[0.59,0.50],[0.61,0.52],[0.63,0.55],[0.62,0.58],[0.60,0.60]],
  ];
  if(S.showConst&&starAlpha>0.3){
    ctx.strokeStyle=`rgba(80,130,190,${starAlpha*0.22})`;ctx.lineWidth=0.6;
    for(const pts of CONST_LINES){
      ctx.beginPath();ctx.moveTo(pts[0][0]*W,pts[0][1]*groundY);
      for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i][0]*W,pts[i][1]*groundY);
      ctx.stroke();
    }
  }

  if(S.showShoot&&starAlpha>0.4&&Math.random()<0.004){
    shootingStars.push({x:Math.random()*W*0.8,y:Math.random()*H*0.35,len:70+Math.random()*100,ang:18+Math.random()*35,spd:10+Math.random()*10,life:1,dec:0.035+Math.random()*0.04});
  }
  shootingStars=shootingStars.filter(s=>s.life>0);
  for(const s of shootingStars){
    const r=s.ang*D2R;
    const g=ctx.createLinearGradient(s.x,s.y,s.x+Math.cos(r)*s.len,s.y+Math.sin(r)*s.len);
    g.addColorStop(0,`rgba(255,255,255,${s.life*0.85})`);g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(s.x+Math.cos(r)*s.len,s.y+Math.sin(r)*s.len);
    ctx.strokeStyle=g;ctx.lineWidth=1.5*s.life;ctx.stroke();
    s.x+=s.spd;s.y+=s.spd*Math.tan(r);s.life-=s.dec;
  }

  // â”€â”€ SUN GLOW (FIX 6: projectAz) â”€â”€
  const sunX=projectAz(sunAz,W);
  const sunY=groundY-(sunAlt/90)*groundY;
  if(sunAlt>-18&&sunAlt<2){
    const t=Math.max(0,(sunAlt+18)/20),gI=t*0.22;
    const hg=ctx.createRadialGradient(sunX,groundY,0,sunX,groundY,W*0.55);
    hg.addColorStop(0,`rgba(255,165,60,${gI})`);hg.addColorStop(0.25,`rgba(200,100,30,${gI*0.5})`);hg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=hg;ctx.fillRect(0,H*0.3,W,H*0.7);
    if(sunAlt>-3&&sunAlt<1){
      const dg=ctx.createRadialGradient(sunX,groundY,0,sunX,groundY,80);
      dg.addColorStop(0,`rgba(255,220,120,${(1-Math.abs(sunAlt)/3)*0.7})`);
      dg.addColorStop(0.4,'rgba(255,140,50,0.3)');dg.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=dg;ctx.fillRect(sunX-80,groundY-80,160,160);
    }
  }

  // â”€â”€ MOON PATH ARC (FIX 7: projectAz) â”€â”€
  if(S.showArc&&c.moonAge>0&&c.moonAge<72){
    if(!S.arcCache) S.arcCache=buildArcCache(S.year,S.month,S.day,S.lat,S.lon);
    ctx.beginPath();let first=true;
    for(const pt of S.arcCache){
      if(pt.alt<-15) continue;
      const ax=projectAz(pt.az,W);       // FIX 7: consistent projection
      const ay=groundY-(pt.alt/90)*groundY;
      if(first){ctx.moveTo(ax,ay);first=false;}else ctx.lineTo(ax,ay);
    }
    ctx.strokeStyle='rgba(200,180,100,0.18)';ctx.lineWidth=1.3;
    ctx.setLineDash([3,5]);ctx.stroke();ctx.setLineDash([]);
  }

  // â”€â”€ GROUND â”€â”€
  const gg=ctx.createLinearGradient(0,groundY,0,H);
  gg.addColorStop(0,'#08121e');gg.addColorStop(0.4,'#050c15');gg.addColorStop(1,'#020609');
  ctx.fillStyle=gg;ctx.fillRect(0,groundY,W,H-groundY);
  ctx.strokeStyle='rgba(30,70,110,0.45)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,groundY);ctx.lineTo(W,groundY);ctx.stroke();

  // â”€â”€ MOON (FIX 6: projectAz) â”€â”€
  if(moonAlt>-5){
    const mx=projectAz(moonAz,W);
    const my=groundY-(moonAlt/90)*groundY;
    const op=Math.min(1,(moonAlt+5)/8);
    const mr=Math.max(5,Math.min(22,c.sd*0.55));
    const moonBright=Math.min(1,op/Math.max(1,extinctionFactor(c.ext.dV)*0.3));

    if(c.illum>0.5){
      const mg=ctxD.createRadialGradient(mx,my,0,mx,my,mr*7);
      mg.addColorStop(0,`rgba(255,248,220,${moonBright*0.12})`);
      mg.addColorStop(0.5,`rgba(255,248,220,${moonBright*0.04})`);
      mg.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=mg;ctx.fillRect(mx-mr*7,my-mr*7,mr*14,mr*14);
    }
    drawMoon(ctx,mx,my,mr,c.illum,c.tilt,moonBright);

    if(moonAlt>0&&moonAlt<20){
      ctx.strokeStyle=`rgba(180,160,80,${moonBright*0.28})`;
      ctx.lineWidth=0.8;ctx.setLineDash([2,4]);
      ctx.beginPath();ctx.moveTo(mx,my);ctx.lineTo(mx,groundY);ctx.stroke();ctx.setLineDash([]);
      ctx.fillStyle=`rgba(180,160,80,${moonBright*0.65})`;
      ctx.font='9px Space Mono';ctx.textAlign='center';
      ctx.fillText(`${moonAlt.toFixed(1)}Â°`,mx,groundY+13);
    }
    if(S.showTopo&&c.topo&&Math.abs(c.topo.dDec)>0.01){
      ctx.fillStyle='rgba(78,205,196,0.5)';ctx.font='8px Space Mono';ctx.textAlign='left';
      ctx.fillText(`topo Î”${c.topo.dDec>0?'+':''}${(c.topo.dDec*60).toFixed(1)}'`,mx+mr+4,my);
    }
    ctx.textAlign='left';
  }

  // â”€â”€ COMPASS (FIX 8: projectAz) â”€â”€
  const cY=groundY+5;
  ctx.fillStyle='rgba(100,140,180,0.45)';ctx.font='9px Space Mono';ctx.textAlign='center';
  [[0,'N'],[90,'E'],[180,'S'],[270,'W']].forEach(([az,lbl])=>{
    const x=projectAz(az,W);
    if(x>20&&x<W-20){
      ctx.beginPath();ctx.moveTo(x,cY-4);ctx.lineTo(x,cY+3);
      ctx.strokeStyle='rgba(100,140,180,0.3)';ctx.lineWidth=1;ctx.stroke();
      ctx.fillText(lbl,x,cY+13);
    }
  });

  requestAnimationFrame(renderLoop);
}

// â”€â”€ ARC CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildArcCache(yr,mo,dy,lat,lon){
  const pts=[];
  for(let h=14;h<=28;h++){
    for(let m=0;m<60;m+=20){
      const hh=h%24,dd=h>=24?1:0;
      const j0=jd(yr,mo,dy+dd,hh,m,0)-S.tz/24;
      const moon=moonPos(j0),L=lst(j0,lon);
      const tc=topoCorrect(moon.ra,moon.dec,moon.dist,L,lat);
      const{alt,az}=eq2hor(tc.ra,tc.dec,L,lat);
      pts.push({alt:apparentAlt(alt),az});
    }
  }
  return pts;
}

// â”€â”€ MOON RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Terminator uses ellipse projection (geometrically correct).
// Single draw path â€” no double-render conflict.
function drawMoon(ctx,x,y,r,illum_pct,tiltDeg,opacity){
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(tiltDeg*D2R);
  ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.clip();

  // Dark base (unlit side)
  ctx.fillStyle=`rgba(12,18,28,${opacity})`;
  ctx.fillRect(-r-1,-r-1,(r+1)*2,(r+1)*2);

  const f=illum_pct/100;
  // Illuminated fraction geometry:
  // The terminator projects as an ellipse with semi-minor axis = r*cos(phaseAngle)
  // where cos(phaseAngle) = 1-2f for waxing, 2f-1 for waning.
  const cosPA=Math.abs(1-2*f); // 1 at new/full, 0 at quarter
  const litGrad=ctx.createRadialGradient(-r*0.15,0,0,0,0,r);
  litGrad.addColorStop(0,`rgba(255,252,236,${opacity})`);
  litGrad.addColorStop(0.65,`rgba(242,236,212,${opacity})`);
  litGrad.addColorStop(1,`rgba(195,190,170,${opacity*0.85})`);

  if(f<=0.5){
    // Waxing crescent â†’ waxing gibbous: right side lit
    // Draw lit right semicircle, then darken the terminator ellipse
    ctx.beginPath();ctx.arc(0,0,r,Math.PI/2,-Math.PI/2,false);ctx.closePath();
    ctx.fillStyle=litGrad;ctx.fill();
    // Dark terminator ellipse (left-facing)
    ctx.save();ctx.scale(cosPA,1);
    ctx.beginPath();ctx.arc(0,0,r,Math.PI/2,-Math.PI/2,false);ctx.closePath();
    ctx.fillStyle=`rgba(12,18,28,${opacity})`;ctx.fill();
    ctx.restore();
  } else {
    // Waning gibbous â†’ waning crescent: left side lit
    ctx.beginPath();ctx.arc(0,0,r,-Math.PI/2,Math.PI/2,false);ctx.closePath();
    ctx.fillStyle=litGrad;ctx.fill();
    // Extend lit area using terminator ellipse (right-facing)
    ctx.save();ctx.scale(cosPA,1);
    ctx.beginPath();ctx.arc(0,0,r,Math.PI/2,-Math.PI/2,false);ctx.closePath();
    ctx.fillStyle=litGrad;ctx.fill();
    ctx.restore();
  }

  // Earthshine
  if(f<0.08&&f>0.005){
    ctx.globalCompositeOperation='lighter';
    ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);
    ctx.fillStyle=`rgba(25,55,90,${opacity*0.07})`;ctx.fill();
    ctx.globalCompositeOperation='source-over';
  }
  // Limb
  ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);
  ctx.strokeStyle=`rgba(255,255,255,${opacity*0.18})`;ctx.lineWidth=0.5;ctx.stroke();
  ctx.restore();
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(){
  recalculate();
  const a=S.cache,v=a.vis;
  const box=document.getElementById('mr-box');
  box.className='mresult';
  if(v.prob>=70){box.classList.add('vis');box.textContent='â˜½ CRESCENT LIKELY VISIBLE';}
  else if(v.prob>=25){box.classList.add('unc');box.textContent='â—‘ VISIBILITY UNCERTAIN';}
  else{box.classList.add('nov');box.textContent='âœ— CRESCENT NOT VISIBLE';}

  const mos=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const nmC=jd2cal(a.nm.jd),nmL=jd2cal(a.nm.jd+S.tz/24);
  const bvtStr=a.bvt?`<div class="crow"><span>Best Visibility Window (local)</span><span style="color:var(--data-green);font-weight:bold">${hhmm(a.bvt.jd,S.tz)} (~${a.bvt.prob.toFixed(0)}% prob)</span></div>`:'';
  const depNote=v.depPen>0?`<div class="crow"><span>Solar Depression Penalty</span><span style="color:#ffa07a">âˆ’${v.depPen.toFixed(0)}% (sky brightness)</span></div>`:'';

  document.getElementById('mr-det').innerHTML=`
<h4>OBSERVATION PARAMETERS</h4>
<div class="crow"><span>Date</span><span style="color:var(--gold)">${S.day} ${mos[S.month-1]} ${S.year}</span></div>
<div class="crow"><span>Location</span><span style="color:var(--data-blue)">${Math.abs(S.lat).toFixed(2)}Â°${S.lat>=0?'N':'S'}, ${Math.abs(S.lon).toFixed(2)}Â°${S.lon>=0?'E':'W'}</span></div>
<div class="crow"><span>UTC Offset</span><span>UTC${S.tz>=0?'+':''}${S.tz}</span></div>

<h4>NEW MOON DATA</h4>
<div class="crow"><span>New Moon (UTC)</span><span style="color:var(--gold)">${String(nmC.hour).padStart(2,'0')}:${String(nmC.min).padStart(2,'0')} ${nmC.day}/${nmC.month}/${nmC.year}</span></div>
<div class="crow"><span>New Moon (Local)</span><span>${String(nmL.hour).padStart(2,'0')}:${String(nmL.min).padStart(2,'0')} ${nmL.day}/${nmL.month}/${nmL.year}</span></div>
<div class="crow"><span>Moon Age at Sunset</span><span style="color:var(--data-blue)">${Math.max(0,a.moonAge).toFixed(2)} hours</span></div>
<div class="crow"><span>Sunset (local)</span><span>${hhmm(a.sunsetJD,S.tz)}</span></div>
<div class="crow"><span>Moonset (local)</span><span>${hhmm(a.moonsetJD,S.tz)}</span></div>
<div class="crow"><span>Lag Time</span><span style="color:${a.lagMin>40?'#4ecdc4':a.lagMin>20?'#ffd700':'#ff6b6b'}">${a.lagMin.toFixed(1)} min</span></div>
${bvtStr}

<h4>TOPOCENTRIC MEASUREMENTS AT SUNSET</h4>
<div class="crow"><span>Moon Altitude (apparent)</span><span style="color:var(--data-blue)">${a.moonAppSS.toFixed(3)}Â°</span></div>
<div class="crow"><span>Sun Altitude (apparent)</span><span>${a.sunAppSS.toFixed(3)}Â°</span></div>
<div class="crow"><span>Topocentric Î”alt</span><span style="color:var(--data-green)">${(a.topo.dDec*60).toFixed(2)}'</span></div>
<div class="crow"><span>Bennett Refraction (Moon)</span><span style="color:var(--data-green)">${(bennetRefraction(a.moonAppSS)*60).toFixed(2)}'</span></div>
<div class="crow"><span>Arc of Vision (ARCV)</span><span style="color:var(--gold)">${v.arcv.toFixed(3)}Â°</span></div>
<div class="crow"><span>Topo Elongation</span><span>${a.elongSS.toFixed(3)}Â°</span></div>
<div class="crow"><span>Illumination</span><span>${a.illum.toFixed(4)}%</span></div>
<div class="crow"><span>Crescent Width W (topo)</span><span>${a.WSS.toFixed(4)} arcmin</span></div>

<h4>ATMOSPHERIC EXTINCTION (Schaefer 1991)</h4>
<div class="crow"><span>Clarity</span><span style="color:var(--data-blue)">${S.atmo.toUpperCase()}</span></div>
<div class="crow"><span>Extinction Coeff k</span><span>${a.ext.k.toFixed(2)} mag/airmass</span></div>
<div class="crow"><span>Airmass X</span><span>${a.ext.X.toFixed(2)}Ã—</span></div>
<div class="crow"><span>Brightness Loss</span><span style="color:${a.ext.dV<0.5?'#4ecdc4':a.ext.dV<1.5?'#ffd700':'#ff6b6b'}">+${a.ext.dV.toFixed(2)} mag</span></div>

<h4>VISIBILITY CRITERIA</h4>
<div class="crow"><span>Danjon Limit (>7.5Â°)</span><span style="color:${danjon(a.elongSS)?'#4ecdc4':'#ff6b6b'}">${danjon(a.elongSS)?'âœ“ PASS':'âœ— FAIL'} (${a.elongSS.toFixed(2)}Â°)</span></div>
<div class="crow"><span>Yallop q</span><span style="color:${v.q>0.216?'#4ecdc4':v.q>-0.232?'#ffd700':'#ff6b6b'}">${v.q.toFixed(5)} â†’ Class ${v.yc.cls}</span></div>
<div class="crow"><span>Yallop Classification</span><span style="color:${v.yc.color}">${v.yc.label}</span></div>
<div class="crow"><span>Odeh V</span><span style="color:${v.V>5.65?'#4ecdc4':v.V>2?'#ffd700':'#ff6b6b'}">${v.V.toFixed(5)}</span></div>
<div class="crow"><span>Odeh Classification</span><span style="color:${v.oc.color}">${v.oc.label}</span></div>
${depNote}

<h4>FINAL RESULT</h4>
<div class="crow"><span>Visibility Class</span><span style="color:${v.color};font-weight:bold">${v.label}</span></div>
<div class="crow"><span>Probability</span><span style="color:${v.prob>=70?'#4ecdc4':v.prob>=30?'#ffd700':'#ff6b6b'};font-weight:bold">${v.prob.toFixed(1)}%</span></div>

<h4>METHODOLOGY</h4>
<p style="font-size:12.5px;line-height:1.8;color:#9aacb8;margin-top:5px">
Moon: ELP-2000/82 (60 longitude + 30 latitude terms, Meeus Ch.47).
Sun: VSOP87 abridged (Meeus Ch.25). Nutation: IAU 1980 (20 terms, Meeus Ch.22).
Topocentric parallax (Meeus Ch.40) applied to <em>both</em> position and elongation â€”
shifts altitude by up to <strong style="color:var(--data-green)">${Math.abs(a.topo.dDec*60).toFixed(1)}'</strong>.
Refraction: Bennett (1982) â€” accurate below 5Â° horizon.
Extinction: Schaefer (1991) Rozenberg airmass.
Solar depression gate: âˆ’5Â° to âˆ’12Â° optimal contrast window.
Yallop (1997) NAO TN 69 + Odeh (2004).
Accuracy: <strong style="color:var(--data-green)">Â±1â€“2 arcminutes</strong> vs published ephemeris.
</p>`;

  document.getElementById('modal').classList.add('show');
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initDate();
recalculate();
requestAnimationFrame(renderLoop);
</script>
</body>
</html>
